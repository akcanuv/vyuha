<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gaudi PDF Annotator and Chat</title>
  <!-- PDF.js viewer CSS -->
  <link rel="stylesheet" href="styles.css">
  <h2 id="name">Gaudi</h2>
  <style>
    /* Styles for the overlay canvas */
    #viewerContainer {
      position: relative;
    }
    #pdf-overlay-canvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
      cursor: crosshair;
    }
    /* Optional: Style for the extracted image */
    #extracted-image {
      margin-top: 20px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <!-- PDF Container -->
  <div id="pdf-container">
    <!-- Controls -->
    <div id="controls">
      <div id="toolbar">
        <input type="file" id="file-input" accept="application/pdf" />
        <button id="prev-page">Previous Page</button>
        <button id="next-page">Next Page</button>
        <span>Page: <span id="page-num"></span> / <span id="page-count"></span></span>
        <button id="zoom-in">Zoom In</button>
        <button id="zoom-out">Zoom Out</button>
      </div>
    </div>
    <!-- PDF Viewer -->
    <div id="viewerContainer">
      <canvas id="pdf-canvas"></canvas>
      <canvas id="pdf-overlay-canvas"></canvas>
    </div>
  </div>

  <!-- Chat Container -->
  <div id="chat-container">
    <div id="chat-messages"></div>
    <div id="chat-input-container">
      <textarea id="chat-input" placeholder="Ask Gaudi..."></textarea>
      <button id="send-button">Send</button>
    </div>
  </div>

  <!-- Include PDF.js library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <!-- Your custom scripts -->
  <script>
    // Set up PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

    // Initialize variables
    const fileInput = document.getElementById('file-input');
    const pdfCanvas = document.getElementById('pdf-canvas');
    const ctx = pdfCanvas.getContext('2d');
    const pdfOverlayCanvas = document.getElementById('pdf-overlay-canvas');
    const overlayCtx = pdfOverlayCanvas.getContext('2d');
    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending = null;
    let scale = 1.5;

    const viewerContainer = document.getElementById('viewerContainer');

    // Buttons and page info
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const pageNumSpan = document.getElementById('page-num');
    const pageCountSpan = document.getElementById('page-count');
    const zoomInBtn = document.getElementById('zoom-in');
    const zoomOutBtn = document.getElementById('zoom-out');

    // Load PDF
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file || file.type !== 'application/pdf') {
        alert('Please upload a PDF file.');
        return;
      }

      const fileReader = new FileReader();
      fileReader.onload = function () {
        const typedarray = new Uint8Array(this.result);
        pdfjsLib.getDocument(typedarray).promise.then((pdfDoc_) => {
          pdfDoc = pdfDoc_;
          pageCountSpan.textContent = pdfDoc.numPages;
          pageNum = 1;
          renderPage(pageNum);
        });
      };
      fileReader.readAsArrayBuffer(file);
    });

    // Render the page
    function renderPage(num) {
      pageRendering = true;
      pdfDoc.getPage(num).then((page) => {
        const viewport = page.getViewport({ scale: scale });
        pdfCanvas.height = viewport.height;
        pdfCanvas.width = viewport.width;

        // Set overlay canvas dimensions
        pdfOverlayCanvas.width = pdfCanvas.width;
        pdfOverlayCanvas.height = pdfCanvas.height;
        pdfOverlayCanvas.style.width = pdfCanvas.style.width;
        pdfOverlayCanvas.style.height = pdfCanvas.style.height;

        const renderContext = {
          canvasContext: ctx,
          viewport: viewport,
        };
        const renderTask = page.render(renderContext);

        renderTask.promise.then(() => {
          pageRendering = false;
          pageNumSpan.textContent = pageNum;
          if (pageNumPending !== null) {
            renderPage(pageNumPending);
            pageNumPending = null;
          }
        });
      });
    }

    // Queue rendering of the next page
    function queueRenderPage(num) {
      if (pageRendering) {
        pageNumPending = num;
      } else {
        renderPage(num);
      }
    }

    // Previous page
    prevPageBtn.addEventListener('click', () => {
      if (pageNum <= 1) return;
      pageNum--;
      queueRenderPage(pageNum);
    });

    // Next page
    nextPageBtn.addEventListener('click', () => {
      if (pageNum >= pdfDoc.numPages) return;
      pageNum++;
      queueRenderPage(pageNum);
    });

    // Zoom in
    zoomInBtn.addEventListener('click', () => {
      scale += 0.25;
      queueRenderPage(pageNum);
    });

    // Zoom out
    zoomOutBtn.addEventListener('click', () => {
      if (scale <= 0.5) return;
      scale -= 0.25;
      queueRenderPage(pageNum);
    });

    // Drawing functionality
    let isDrawing = false;
    let startX, startY, currentX, currentY;

    pdfOverlayCanvas.addEventListener('mousedown', function(e) {
      isDrawing = true;
      const rect = pdfOverlayCanvas.getBoundingClientRect();
      startX = (e.clientX - rect.left) * (pdfOverlayCanvas.width / rect.width);
      startY = (e.clientY - rect.top) * (pdfOverlayCanvas.height / rect.height);
    });

    pdfOverlayCanvas.addEventListener('mousemove', function(e) {
      if (!isDrawing) return;
      const rect = pdfOverlayCanvas.getBoundingClientRect();
      currentX = (e.clientX - rect.left) * (pdfOverlayCanvas.width / rect.width);
      currentY = (e.clientY - rect.top) * (pdfOverlayCanvas.height / rect.height);

      // Clear the overlay canvas
      overlayCtx.clearRect(0, 0, pdfOverlayCanvas.width, pdfOverlayCanvas.height);

      // Draw the rectangle
      overlayCtx.beginPath();
      overlayCtx.rect(startX, startY, currentX - startX, currentY - startY);
      overlayCtx.lineWidth = 2;
      overlayCtx.strokeStyle = 'red';
      overlayCtx.stroke();
    });

    pdfOverlayCanvas.addEventListener('mouseup', function(e) {
      if (!isDrawing) return;
      isDrawing = false;
      const rect = pdfOverlayCanvas.getBoundingClientRect();
      currentX = (e.clientX - rect.left) * (pdfOverlayCanvas.width / rect.width);
      currentY = (e.clientY - rect.top) * (pdfOverlayCanvas.height / rect.height);

      // Extract the image
      extractImage();

      // Clear the overlay canvas
      overlayCtx.clearRect(0, 0, pdfOverlayCanvas.width, pdfOverlayCanvas.height);
    });

    function extractImage() {
      // Calculate the rectangle coordinates
      const x = Math.min(startX, currentX);
      const y = Math.min(startY, currentY);
      const width = Math.abs(currentX - startX);
      const height = Math.abs(currentY - startY);

      if (width === 0 || height === 0) {
        alert('Please select a valid area.');
        return;
      }

      // Get the image data from the pdfCanvas
      const imageData = ctx.getImageData(x, y, width, height);

      // Create a new canvas to hold the extracted image
      const extractedCanvas = document.createElement('canvas');
      extractedCanvas.width = width;
      extractedCanvas.height = height;
      const extractedCtx = extractedCanvas.getContext('2d');

      // Put the image data into the new canvas
      extractedCtx.putImageData(imageData, 0, 0);

      // Convert the canvas to an image (data URL)
      const dataURL = extractedCanvas.toDataURL('image/png');

      // Display the extracted image
      const img = document.createElement('img');
      img.src = dataURL;
      img.id = 'extracted-image';
      document.body.appendChild(img);
    }

    // Chat functionality
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');

    sendButton.addEventListener('click', async function () {
      const message = chatInput.value.trim();
      if (!message) return;

      // Get the selected text from the PDF canvas
      const selection = window.getSelection();
      let snippet = '';
      if (selection.rangeCount > 0) {
        snippet = selection.toString();
      }

      // Display user's message
      addChatMessage('User', message);

      // Clear input
      chatInput.value = '';

      // Send to backend
      try {
        const response = await fetch('YOUR_BACKEND_URL/api/chat', { // Replace with your backend URL
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, snippet }),
        });
        const data = await response.json();
        if (data.reply) {
          addChatMessage('Gaudi', data.reply);
        } else {
          addChatMessage('Gaudi', 'Sorry, I could not process your request.');
        }
      } catch (error) {
        console.error(error);
        addChatMessage('Gaudi', 'Error communicating with the server.');
      }
    });

    function addChatMessage(sender, text) {
      const messageElem = document.createElement('div');
      messageElem.className = 'chat-message';
      messageElem.innerHTML = `<strong>${sender}:</strong> ${text}`;
      chatMessages.appendChild(messageElem);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Allow pressing Enter to send message
    chatInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendButton.click();
      }
    });
  </script>
</body>
</html>